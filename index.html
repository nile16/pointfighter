<!DOCTYPE html>

<html>

<head>
<meta charset='utf-8' />
<title>PointFighter</title>
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0,  minimum-scale=1.0"> 
<meta name="google-signin-client_id" content="219844659207-ct72vss7fte5ct6ka8j0jcuocjcrevpl.apps.googleusercontent.com">
<link rel="stylesheet" href="pf.css" />
<link rel="stylesheet" href="leaflet/leaflet.css" />
<script src="leaflet/leaflet.js"></script> 
<script src="screenfull.js"></script>
<script src="https://apis.google.com/js/platform.js" ></script>
<script src="//connect.facebook.net/en_US/sdk.js" id="facebook-jssdk" ></script>

</head>                                                                                
                                                                                  
                                                                                  
<body>                                                                            
   <div  id='wrapper' >
	<div id='dimmer' ></div>
	<div id='bar1Wrap' >
		<div id='bar1' ></div>
		<div id='bar1text' ></div>
	</div>
	<div id='bar2Wrap' >
		<div id='bar2' ></div>
		<div id='bar2text' ></div>
	</div>
    <div id='buttonRow' >
		<div class="button" id='b1' ><IMG id="zoomToUserButton" src="icons/b1.png"  title="Centre map at your position" onclick="zoomToUser();" ></div>
<!--		<div class="button" id='b2' ><IMG id="loginButton"      src="icons/b2.png"  title="Logout" onclick="logout();" ></div> -->
		<div class="button" id='b3' ><IMG id="profileButton"    src="icons/b3.png"  title="Menu" onclick="showProfileBox();" ></div>
		<div class="button" id='b4' ><IMG id="mapButton"        src="icons/b4.png"  title="Maps" onclick="showMapMenu();" ></div>
		<div class="button" id='b5' ><IMG id="fullScreenButton" src="icons/b51.png" title="Request Full Screen" onclick="screenfull.request();" ></div>
	</div>
    <div id='main' >
		<div id='map' ></div>
<!--		<div id='zoomControl' >
			<div class="zoomButton" ><IMG align="middle" style="width:100%; height:100%;" src="icons/c1.png" title="Zoom In"  onclick="map.zoomIn();" ></div>
			<div class="zoomButton" ><IMG align="middle" style="width:100%; height:100%;" src="icons/c2.png" title="Zoom Out" onclick="map.zoomOut();" ></div>
		</div>-->

		<div id='help' ></div>
	</div>
	<div id='loginBox' >
		<img id="loginLogo" src="logo.png"><br><br>
		<div class="loginButton" onclick="loginGoogle()"><img src="g.png"></div><br>
		<div class="loginButton" onclick="loginFacebook()"><img src="fb.png"></div>
		<!--<div class="loginButton" onclick="hideLoginBox()">Cancel</div>-->
	</div>
	<div id='mapBox' >
		<div class="mapButton" onclick="setMap(mapbox)">OSM (Mapbox)</div><br>
		<div class="mapButton" onclick="setMap(osm)">OSM (Mapnik)</div><br>
		<div class="mapButton" onclick="setMap(googleStreets)">Google Street</div><br>
		<div class="mapButton" onclick="setMap(googleTerrain)">Google Terrain</div><br>
		<div class="mapButton" onclick="setMap(googleSat)">Google Earth</div><br>
		<!--<div class="loginButton" onclick="hideLoginBox()">Cancel</div>-->
	</div>
	<div id='profileBox' >
		<br>
		<img id="userPicDiv"><br>
		Nick: <div id="userNameDiv" contenteditable="true"></div><br>
		Health: <div id="userHealthDiv"></div><br>
		Level: <div id="userLevelDiv"></div><br>
		Skin: <div id="userSkinDiv" contenteditable="true"></div><br>
		Speed: <div id="userSpeedDiv"></div><br>
		Attack: <div id="userAttackDiv"></div><br>
		Defence: <div id="userDefenceDiv"></div><br>
		<br>
		<button onclick="saveProfile();">QUIT and SAVE</button>
		<button onclick="logout();">LOGOUT</button><br>
	</div>
	<div id='message' ></div>
   </div>
</body>


<script>



//Initiate Facebook
window.fbAsyncInit = function() {
    FB.init({
      appId      : '360731194320516',
      cookie     : true,
      xfbml      : true,
      version    : 'v2.8'
    });
    FB.AppEvents.logPageView(); 
  	FB.getLoginStatus(function(response) {
		if (response.status=="connected") onSignInFacebook();
	});
  };

//Initiate Google  
gapi.load('auth2', function() {
	gapi.auth2.init({
		client_id: '219844659207-ct72vss7fte5ct6ka8j0jcuocjcrevpl.apps.googleusercontent.com'
	});
});

//Initiate login with Facebook
function loginFacebook(){
	FB.login(onSignInFacebook);
}

//Initiate login with Google
function loginGoogle(){
	gapi.auth2.getAuthInstance().signIn().then(onSignInGoogle);
}

//Show the login buttons for Google and Facebook
function showLoginBox(){
    document.getElementById('dimmer').style.display     = 'block'; 
	document.getElementById('loginBox').style.display   = 'block';
}

//Hide the login buttons for Google and Facebook
function hideLoginBox(){
    document.getElementById('dimmer').style.display     = 'none'; 
	document.getElementById('loginBox').style.display   = 'none';
}

//Show the profile page
function showProfileBox(){
	document.getElementById('dimmer').style.display     = 'block'; 
	document.getElementById('profileBox').style.display = 'block';
}

//Hide the profile page and save profil data to server
function saveProfile(){
	document.getElementById('dimmer').style.display     = 'none'; 
	document.getElementById('profileBox').style.display = 'none';

	var xhr = new XMLHttpRequest();
	xhr.open("POST", "https://nile16.nu:1208/", true);
	xhr.onreadystatechange = function(){

		if(this.readyState == 4 && this.status == 200) {
			removeMyMarkerFromMap();
			console.log(xhr.responseText);
			var userdata = JSON.parse(xhr.responseText);
			user.una = userdata.una;
			user.pic = userdata.pic;
			user.ski = userdata.ski;
			user.hea = userdata.hea;
			user.lev = userdata.lev;
			user.spd = userdata.spd;
			user.ata = userdata.ata;
			user.def = userdata.def;
			userPicDiv.src          = user.pic;
			userNameDiv.innerText   = user.una;
			userSkinDiv.innerText   = user.ski;
		}
	}
	xhr.send(JSON.stringify({com:"usr",acc:user.account,tok:user.token(),una:userNameDiv.innerText,ski:userSkinDiv.innerText}));
}

function removeMyMarkerFromMap(){
	if (marker){
		map.removeLayer(marker);
		marker=false;
	}
}

function setBar(bar,procent){
	document.getElementById(bar+'text').innerText = procent+"%";
	procent = 100 - procent + "%";
	document.getElementById(bar).style.right = procent;
}

function onSignInGoogle(googleUser){
    if (user.account=="facebook") FB.logout();
	hideLoginBox();
	var profile = googleUser.getBasicProfile();
	//user.token=String(googleUser.getAuthResponse().id_token);
	user.account="google";
	//console.log("logged in google");
	loginServer();
}

function onSignInFacebook(){
    if (user.account=="google") gapi.auth2.getAuthInstance().signOut();
	FB.getLoginStatus(function(response) {
		if (response.status=="connected"){
			hideLoginBox();
			//user.token=String(response.authResponse.accessToken);
			user.account="facebook";
			//console.log("logged in facebook");
			loginServer();
			//FB.api('/me', function(response) {
			//	user.name=response.name;
			//	startGPS();
			//	user.id=response.id;
			//	user.image=response.picture;
			//});
		}
	});
}

function logout(){
	saveProfile();
    if (user.account=="google") gapi.auth2.getAuthInstance().signOut();
    if (user.account=="facebook")FB.logout();
	showLoginBox();
	//document.getElementById('loginButton').setAttribute( "src", "icons/login.png" ); 
	//document.getElementById('loginButton').setAttribute( "title", "Login" ); 
	//document.getElementById('loginButton').setAttribute( "onClick", "javascript: showLoginBox();" );
	user.account=false;
	user.name=false;
	user.id=false;
	user.picture=false;
	removeMyMarkerFromMap();
	markers.clearLayers();
	setBar('bar1',0);
	setBar('bar2',0);
	stopPosUpdates();
	stopGPS();
}

  if (screenfull.enabled) {
    document.addEventListener(screenfull.raw.fullscreenchange, function () {
        if (screenfull.isFullscreen) {
		  document.getElementById('fullScreenButton').setAttribute( "src", "icons/b50.png" ); 
          document.getElementById('fullScreenButton').setAttribute( "title", "Exit Full Screen" ); 
          document.getElementById('fullScreenButton').setAttribute( "onClick", "javascript: screenfull.exit();" ); 
        } else {
		  document.getElementById('fullScreenButton').setAttribute( "src", "icons/b51.png" ); 
          document.getElementById('fullScreenButton').setAttribute( "title", "Request Full Screen" ); 
          document.getElementById('fullScreenButton').setAttribute( "onClick", "javascript: screenfull.request();" ); 
        }
	  } );
	}

function loginServer(){
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "https://nile16.nu:1208", true);
	xhr.onreadystatechange = function(){

		if(this.readyState == 4 && this.status == 200) {
			console.log(xhr.responseText);
			var userdata = JSON.parse(xhr.responseText);
			user.una = userdata.una;
			user.pic = userdata.pic;
			user.ski = userdata.ski;
			user.spd = userdata.spd;
			user.ata = userdata.ata;
			user.def = userdata.def;
			user.hea = userdata.hea;
			user.lev = userdata.lev;
			setBar('bar1',user.hea);
			setBar('bar2',user.lev);
			userPicDiv.src           = user.pic;
			userNameDiv.innerText    = user.una;
			userHealthDiv.innerText  = user.hea;
			userLevelDiv.innerText   = user.lev;
			userSkinDiv.innerText    = user.ski;
			userSpeedDiv.innerText   = user.spd;
			userAttackDiv.innerText  = user.ata;
			userDefenceDiv.innerText = user.def;
			startGPS();
			startPosUpdates();
			//loadPoints();
		}
	}
	xhr.send(JSON.stringify({com:"usr",acc:user.account,tok:user.token()}));
}
	
function updatePosition(pos){
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "https://nile16.nu:1208/", true);
	xhr.onreadystatechange = function(){

		if(this.readyState == 4 && this.status == 200) {
			var pmarkers = [];
			other_users = JSON.parse(xhr.responseText).ous;
			for (i=0;i<other_users.length;i++){
				var icon = L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" src="'+other_users[i][2]+'"></div><div class="iconName" onclick="event.stopPropagation()">'+other_users[i][1]+'</div>',iconAnchor:[8, 8]});
				pmarkers[i] = L.marker(other_users[i][0],{draggable:false, icon:icon}).addTo(map);
			}
			markers.clearLayers();
			markers = L.featureGroup(pmarkers);
			markers.addTo(map);
		}
	}
	xhr.send(JSON.stringify({com:"pos",acc:user.account,tok:user.token(),pos:pos}));
}



function startGPS(){
	posWatch=navigator.geolocation.watchPosition(
		function(pos){ 
			if (pos.coords.accuracy<50000) // Change to lower value before launch
				position_found(pos); 
			else
				position_not_found();
		},
		function(error){ 
			position_not_found(); 
		},
		{ enableHighAccuracy:true, timeout:15000, maximumAge:10000 });
}
  
function stopGPS(){
	navigator.geolocation.clearWatch(posWatch);
}  

  function position_found(pos) {
	console.log("posfound");
    if (!marker){
		var icon = L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" src="'+user.pic+'"></div><div class="iconName" onclick="event.stopPropagation()">'+user.una+'</div>',iconAnchor:[12, 12]});
		marker = L.marker([pos.coords.latitude, pos.coords.longitude], {draggable:false, icon:icon}).addTo(map);
		}
	else{
		marker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
		//marker.update();
		}
	checkDistances();
  }

  function position_not_found() {
	removeMyMarkerFromMap();
  }

  function startPosUpdates(){
	posUpdates = setInterval(function(){
		if (marker)	updatePosition([parseFloat(marker.getLatLng().lat.toFixed(5)), parseFloat(marker.getLatLng().lng.toFixed(5))]);
	}, 5000);
  }

  function stopPosUpdates(){
	clearInterval(posUpdates);
  }
  
  
function zoomToUser(){
	if (marker) map.setView(marker.getLatLng(), 16);
}  
 
function showMapMenu(){
    document.getElementById('dimmer').style.display  = 'block'; 
    document.getElementById('mapBox').style.display  = 'block'; 
}
 
function setMap(m){
	map.removeLayer(currentMap); 
	currentMap=m;
	map.addLayer(m); 
	document.getElementById('dimmer').style.display  = 'none'; 
	document.getElementById('mapBox').style.display  = 'none'; 
}
  
  function showMessage(mess) {
    document.getElementById('dimmer').style.display  = 'block'; 
    document.getElementById('message').innerHTML = '<div id="closeMessageButton" onclick="closeMessage()" >x</div>' + mess; 
    document.getElementById('message').style.display = 'block';
  }  
  
  function closeMessage() {
    document.getElementById('message').style.display = 'none'; 
    document.getElementById('dimmer').style.display  = 'none'; 
  }
  
function distance(lat1, lon1, lat2, lon2) {
	var radlat1 = Math.PI * lat1/180
	var radlat2 = Math.PI * lat2/180
	var theta = lon1-lon2
	var radtheta = Math.PI * theta/180
	var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
	dist = Math.acos(dist)
	dist = dist * 180/Math.PI
	dist = dist * 60 * 1.1515 * 1609
	return dist
}

function checkDistances(){
	var lat = marker.getLatLng().lat;
	var lng = marker.getLatLng().lng;
	for (i=0;i<targets.length;i++){
		if (distance(lat,lng,targets[i].getLatLng().lat,targets[i].getLatLng().lng)<10){
			targets[i].setIcon(markerIcon2);
		}
	}
}


  // OSM layer
  var osmUrl='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  var osmAttrib='<a href="http://openstreetmap.org" target="_blank">OpenStreetMap</a>';
  var osm = new L.TileLayer(osmUrl, {minZoom:1, maxZoom:19});		
 
  // Mapbox layer
  var mapbox = L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=' + 'pk.eyJ1Ijoic2VhcmNob3NtIiwiYSI6ImNpZ21vN2J0NzAwMjJhYWx4Zm95aTk1NW8ifQ.JmAKk8EayQ6cwMDJp-ZwVg', {minZoom:1, maxZoom: 18});

  // Google Map layer
  var googleAttrib='<a href="http://www.google.com/maps" target="_blank">GoogleMaps</a>';
  var googleStreets = new L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{minZoom:1, maxZoom: 19, subdomains:['mt0','mt1','mt2','mt3']});

  // Google terrain layer
  var googleTerrain = new L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{minZoom:1, maxZoom: 19, subdomains:['mt0','mt1','mt2','mt3']});

  // Google Earth layer
  var googleSat = new L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{minZoom:1, maxZoom: 19, subdomains:['mt0','mt1','mt2','mt3']});

  
  var map = new L.Map('map', { doubleClickZoom:false, zoomControl:false, maxBounds:([[90,-270],[-90,270]]) });

  map.attributionControl.setPrefix("");


var user={};

var posUpdates;
var posWatch;

user.token=function (){
    if (user.account=="google")		return gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token;
    if (user.account=="facebook")	return FB.getAuthResponse().accessToken;
	return false;
}


  var targets=[];
  var marker = false;
  var markers = L.featureGroup();
  
  //Set initial map view
  var currentMap=mapbox;
  
  //var markerIcon  = L.icon({iconUrl: "icons/0.png",iconAnchor:[8, 8],});
  var ios     = /(iPad|iPhone|iPod)/g.test(navigator.userAgent);
  var android = /(android)/i.test(navigator.userAgent);

  // Add layers to map
  currentMap.addTo(map);


  // map.addLayer(markers);
  map.fitBounds([[0,-180],[0,180]]);

  
  var pointsList=[
	[1 ,1,[56.43956,14.61423],"<b>Vita Sten</b><br>Gammal gränssten mellan Sverige och Danmark."],
	[2 ,2,[56.24739,15.27352],"<b>Luftvärnsbatteri</b><br>"],
	[3 ,3,[56.15904,15.13374],"<b>Väbynäs Bunker</b><br>Byggdes under andra världskriget."],
	[4 ,4,[56.15181,14.66973],"<b>Listers Härads Avrättningsplats</b><br>"],
	[5 ,1,[56.43655,14.57008],"<b>B17 Haveriplats</b><br>Ett Amerikanskt B17-plan gick ner här under andra världskriget."],
	[6 ,2,[56.46642,14.65185],"<b>Kyrkö Mosse Bilkyrkogård</b><br>"],
	[7 ,1,[56.32149,16.03863],"<b>Fredsstenen</b><br>Softa och heala dig här."],
	[8 ,1,[56.22892,14.88335],"<b>Tararps Jättegrytor</b><br>Jättefina jättegrytor!"],
	[9 ,1,[56.22124,15.10608],"<b>SnittingeFallet</b><br>Bräkne-Hobys stolthet. Softa och heala dig här."],
	[10,1,[56.22975,15.13352],"<b>Bräkne-Hoby Jättegryta</b><br>Softa och heala dig här."],
	[11,1,[56.23663,15.27620],"<b>Djupaforsklyftan</b><br>Här rinner Ronnebyån genom en 18 m djup ränna som bara är 1,5 m bred. Branta sluttningar med stora flyttblock och vacker bokskog reser sig över ån. Softa och heala dig här."],
	[12,1,[56.25340,15.33798],"<b>Anglestue Grotta</b><br>"],
	[13,1,[56.17114,14.96547],"<b>Hitlersten</b><br>Här höggs granit till Germania. Softa och heala dig här."],
	[14,2,[56.16467,14.86941],"<b>Utvandrarmonumentet</b><br>"],
	[15,1,[56.14925,14.84510],"<b>Höga Rör</b><br>Ett fem meter högt gravröse daterat till bronsåldern, benämnt Höga rör, vilket är Blekinges största. Softa och heala dig här."],
	[16,4,[56.53349,15.60082],"<b>Dackestenen</b><br>"],
	[17,1,[56.41925,15.68378],"<b>Nils Dackes Forna Hemvist i Flaken</b><br>"],
	[18,2,[56.48171,15.68788],"<b>Nils Dackes Forna Lindö Gård</b><br>"],
	[19,3,[56.40302,15.66007],"<b>Platsen för mordet på Nils Dacke</b><br>Kriga mot Gustav Vasas legoknektar!"],
	[20,4,[56.47071,15.34233],"<b>Railroad memorial May 27 1908</b><br>"],
	[21,1,[56.40602,15.67169],"<b>Sörsjö-Jons Stuga; Nils Dackes Gömställe</b><br>Softa och heala dig här."],
	[22,4,[56.42517,15.72576],"<b>Tullstation</b><br>Gammal tullstation vid forna gränsen mellan Sverige och Danmark."],
	[23,3,[56.07385,15.73029],"<b>U137 Gick på grund här</b><br>Kriga mot Sovjet!"],
	[24,1,[56.11835,15.83494],"<b>Hällristning Hästhallen</b><br>Hästhallen är Blekinges största hällristning och består av 140 ristningar uppdelade i sju grupper. Motiven utgörs av människor, skepp, hästar och ryttare, hjortdjur, solhjul, fotsulor och skålgropar. Hällristningarna är daterade till bronsåldern, omkring 1000 före Kristus."],
	[25,1,[56.20273,15.37919],"<b>Björketorps-stenen</b><br>"],
	[26,1,[56.44135,14.52813],"<b>Rävabacken</b><br>Högsta punkt i Blekinge. Softa och heala dig här."],
	[27,1,[56.02162,14.18389],"<b>Sveriges lägsta punkt</b><br>"],
	[28,1,[55.68266,14.23383],"<b>Kungagraven</b><br>Kungagraven, även benämnd Kiviksgraven eller Bredarör, är ett gravröse beläget i Kivik i Södra Mellby socken och Simrishamns kommun. Det är en gravplats från bronsåldern, som under historisk tid både förstörts delvis, plundrats och restaurerats till ett icke ursprungligt skick."]
	];
	
	
function iconClicked(i){
	//console.log(distance(marker.getLatLng().lat,marker.getLatLng().lng,pointsList[i][2][0],pointsList[i][2][1]));
	showMessage(pointsList[i][3]);
}
	
	
	
function loadPoints(){
	for (i=0;i<pointsList.length;i++){
		if (pointsList[i][1]==1) markers[i]=L.marker(pointsList[i][2],{draggable:false, icon:L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" onclick="iconClicked('+i+')" src="icons/1.png"></div>',iconAnchor:[8, 8]})}).addTo(map);
		if (pointsList[i][1]==2) markers[i]=L.marker(pointsList[i][2],{draggable:false, icon:L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" onclick="iconClicked('+i+')" src="icons/2.png"></div>',iconAnchor:[8, 8]})}).addTo(map);
		if (pointsList[i][1]==3) markers[i]=L.marker(pointsList[i][2],{draggable:false, icon:L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" onclick="iconClicked('+i+')" src="icons/3.png"></div>',iconAnchor:[8, 8]})}).addTo(map);
		if (pointsList[i][1]==4) markers[i]=L.marker(pointsList[i][2],{draggable:false, icon:L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" onclick="iconClicked('+i+')" src="icons/4.png"></div>',iconAnchor:[8, 8]})}).addTo(map);
	}
}

  </script>                              

</html>

