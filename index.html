<!DOCTYPE html>

<html>

<head>
<meta charset='utf-8' />
<title>PointFighter</title>
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0,  minimum-scale=1.0"> 
<meta name="google-signin-client_id" content="219844659207-ct72vss7fte5ct6ka8j0jcuocjcrevpl.apps.googleusercontent.com">
<link rel="stylesheet" href="pf.css" />
<link rel="stylesheet" href="leaflet/leaflet.css" />
<script src="leaflet/leaflet.js"></script> 
<script src="screenfull.js"></script>
<script src="https://apis.google.com/js/platform.js" ></script>
<script src="//connect.facebook.net/en_US/sdk.js" id="facebook-jssdk" ></script>
</head>                                                                                
                                                                                  
                                                                                  
<body>                                                                            
   <div  id='wrapper' >
    <iframe id="gameFrame" src=""></iframe>
	<div id="closeGameFrame" onclick="closeGame()"><img src="icons/close.png"></div>
	<div id='dimmer' ></div>
	<div id='bar1Wrap' >
		<div id='bar1' ></div>
		<div id='bar1text' ></div>
	</div>
	<div id='bar2Wrap' >
		<div id='bar2' ></div>
		<div id='bar2text' ></div>
	</div>
    <div id='buttonRow' >
		<div class="button" id='b1' ><IMG id="zoomToUserButton" src="icons/b1.png"  title="Centre map at your position" onclick="zoomToUser();" ></div>
<!--		<div class="button" id='b2' ><IMG id="loginButton"      src="icons/b2.png"  title="Logout" onclick="logout();" ></div> -->
		<div class="button" id='b3' ><IMG id="profileButton"    src="icons/b3.png"  title="Menu" onclick="showProfileBox();" ></div>
		<div class="button" id='b4' ><IMG id="mapButton"        src="icons/b4.png"  title="Maps" onclick="showMapMenu();" ></div>
		<div class="button" id='b5' ><IMG id="fullScreenButton" src="icons/b51.png" title="Request Full Screen" onclick="screenfull.request();" ></div>
	</div>
    <div id='main' >
		<div id='map' ></div>
<!--		<div id='zoomControl' >
			<div class="zoomButton" ><IMG align="middle" style="width:100%; height:100%;" src="icons/c1.png" title="Zoom In"  onclick="map.zoomIn();" ></div>
			<div class="zoomButton" ><IMG align="middle" style="width:100%; height:100%;" src="icons/c2.png" title="Zoom Out" onclick="map.zoomOut();" ></div>
		</div>-->

		<div id='help' ></div>
	</div>
	<div id='loginBox' >
		<img id="loginLogo" src="logo.png"><br><br>
		<div class="loginButton" onclick="loginGoogle()"><img src="g.png"></div><br>
		<div class="loginButton" onclick="loginFacebook()"><img src="fb.png"></div>
		<!--<div class="loginButton" onclick="hideLoginBox()">Cancel</div>-->
	</div>
	<div id='mapBox' >
		<div class="mapButton" onclick="setMap(mapbox)">OSM (Mapbox)</div><br>
		<div class="mapButton" onclick="setMap(osm)">OSM (Mapnik)</div><br>
		<div class="mapButton" onclick="setMap(googleStreets)">Google Street</div><br>
		<div class="mapButton" onclick="setMap(googleTerrain)">Google Terrain</div><br>
		<div class="mapButton" onclick="setMap(googleSat)">Google Earth</div><br>
		<!--<div class="loginButton" onclick="hideLoginBox()">Cancel</div>-->
	</div>
	<div id='profileBox' >
		<br>
		<img id="userPicDiv"><br>
		Nick: <div id="userNameDiv" contenteditable="true"></div><br>
		Health: <div id="userHealthDiv"></div><br>
		Level: <div id="userLevelDiv"></div><br>
		Skin: <div id="userSkinDiv" contenteditable="true"></div><br>
		Weapon: <div id="userWeaponDiv"></div><br>
		Speed: <div id="userSpeedDiv"></div><br>
		Attack: <div id="userAttackDiv"></div><br>
		Defence: <div id="userDefenceDiv"></div><br>
		<br>
		<button onclick="saveProfile();">QUIT and SAVE</button>
		<button onclick="logout();">LOGOUT</button><br>
	</div>
	<div id='message' ></div>
   </div>
</body>


<script>



//Initiate Facebook
window.fbAsyncInit = function() {
    FB.init({
      appId      : '360731194320516',
      cookie     : true,
      xfbml      : true,
      version    : 'v2.8'
    });
    FB.AppEvents.logPageView(); 
  	FB.getLoginStatus(function(response) {
		if (response.status=="connected") onSignInFacebook();
	});
  };

//Initiate Google  
gapi.load('auth2', function() {
	gapi.auth2.init({
		client_id: '219844659207-ct72vss7fte5ct6ka8j0jcuocjcrevpl.apps.googleusercontent.com'
	});
});

//Initiate login with Facebook
function loginFacebook(){
	FB.login(onSignInFacebook);
}

//Initiate login with Google
function loginGoogle(){
	gapi.auth2.getAuthInstance().signIn().then(onSignInGoogle);
}

//Show the login buttons for Google and Facebook
function showLoginBox(){
    document.getElementById('dimmer').style.display     = 'block'; 
	document.getElementById('loginBox').style.display   = 'block';
}

//Hide the login buttons for Google and Facebook
function hideLoginBox(){
    document.getElementById('dimmer').style.display     = 'none'; 
	document.getElementById('loginBox').style.display   = 'none';
}

//Show the profile page
function showProfileBox(){
	document.getElementById('dimmer').style.display     = 'block'; 
	document.getElementById('profileBox').style.display = 'block';
}

//Hide the profile page and save profil data to server
function saveProfile(){
	document.getElementById('dimmer').style.display     = 'none'; 
	document.getElementById('profileBox').style.display = 'none';

	var xhr = new XMLHttpRequest();
	xhr.open("POST", "https://nile16.nu:1208/", true);
	xhr.onreadystatechange = function(){

		if(this.readyState == 4 && this.status == 200) {
			removeMyMarkerFromMap();
			console.log(xhr.responseText);
			updateUserProfile(JSON.parse(xhr.responseText));
		}
	}
	xhr.send(JSON.stringify({com:"usr",acc:user.acc,tok:user.tok(),una:userNameDiv.innerText,ski:userSkinDiv.innerText}));
}

function removeMyMarkerFromMap(){
	if (marker){
		map.removeLayer(marker);
		marker=false;
	}
}

function setBar(bar,procent){
	document.getElementById(bar+'text').innerText = procent+"%";
	procent = 100 - procent + "%";
	document.getElementById(bar).style.right = procent;
}

function onSignInGoogle(googleUser){
    if (user.acc=="facebook") FB.logout();
	hideLoginBox();
	var profile = googleUser.getBasicProfile();
	//user.token=String(googleUser.getAuthResponse().id_token);
	user.acc="google";
	//console.log("logged in google");
	loginServer();
}

function onSignInFacebook(){
    if (user.acc=="google") gapi.auth2.getAuthInstance().signOut();
	FB.getLoginStatus(function(response) {
		if (response.status=="connected"){
			hideLoginBox();
			user.acc="facebook";
			//console.log("logged in facebook");
			loginServer();
			//FB.api('/me', function(response) {
			//	user.name=response.name;
			//	startGPS();
			//	user.id=response.id;
			//	user.image=response.picture;
			//});
		}
	});
}

function logout(){
	saveProfile();
    if (user.acc=="google") gapi.auth2.getAuthInstance().signOut();
    if (user.acc=="facebook")FB.logout();
	showLoginBox();
	user.acc = false;
	user.una = false;
	user.uid = false;
	user.pic = false;
	user.ski = false;
	user.wea = false;
	user.spd = false;
	user.ata = false;
	user.def = false;
	user.hea = false;
	user.lev = false;
	removeMyMarkerFromMap();
	markers.clearLayers();
	setBar('bar1',0);
	setBar('bar2',0);
	stopPosUpdates();
	stopHealingChecks();
	stopGPS();
}

  if (screenfull.enabled) {
    document.addEventListener(screenfull.raw.fullscreenchange, function () {
        if (screenfull.isFullscreen) {
		  document.getElementById('fullScreenButton').setAttribute( "src", "icons/b50.png" ); 
          document.getElementById('fullScreenButton').setAttribute( "title", "Exit Full Screen" ); 
          document.getElementById('fullScreenButton').setAttribute( "onClick", "javascript: screenfull.exit();" ); 
        } else {
		  document.getElementById('fullScreenButton').setAttribute( "src", "icons/b51.png" ); 
          document.getElementById('fullScreenButton').setAttribute( "title", "Request Full Screen" ); 
          document.getElementById('fullScreenButton').setAttribute( "onClick", "javascript: screenfull.request();" ); 
        }
	  } );
	}

function loginServer(){
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "https://nile16.nu:1208", true);
	xhr.onreadystatechange = function(){

		if(this.readyState == 4 && this.status == 200) {
			console.log(xhr.responseText);
			updateUserProfile(JSON.parse(xhr.responseText));
			startGPS();
			startPosUpdates();
			loadPoints();
			startHealingChecks();
		}
	}
	xhr.send(JSON.stringify({com:"usr",acc:user.acc,tok:user.tok()}));
}

function updateUserProfile(data){
	user.una = data.una;
	user.pic = data.pic;
	user.ski = data.ski;
	user.wea = data.wea;
	user.spd = data.spd;
	user.ata = data.ata;
	user.def = data.def;
	user.hea = data.hea;
	user.lev = data.lev;
	setBar('bar1',user.hea);
	setBar('bar2',user.lev);
	userPicDiv.src           = user.pic;
	userNameDiv.innerText    = user.una;
	userHealthDiv.innerText  = user.hea;
	userLevelDiv.innerText   = user.lev;
	userSkinDiv.innerText    = user.ski;
	userWeaponDiv.innerText  = user.wea;
	userSpeedDiv.innerText   = user.spd;
	userAttackDiv.innerText  = user.ata;
	userDefenceDiv.innerText = user.def;
}


	
function updatePosition(pos){
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "https://nile16.nu:1208/", true);
	xhr.onreadystatechange = function(){

		if(this.readyState == 4 && this.status == 200) {
			var pmarkers = [];
			other_users = JSON.parse(xhr.responseText).ous;
			for (i=0;i<other_users.length;i++){
				var icon = L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" src="'+other_users[i][2]+'"></div><div class="iconName" onclick="event.stopPropagation()">'+other_users[i][1]+'</div>',iconAnchor:[8, 8]});
				pmarkers[i] = L.marker(other_users[i][0],{draggable:false, icon:icon}).addTo(map);
			}
			markers.clearLayers();
			markers = L.featureGroup(pmarkers);
			markers.addTo(map);
		}
	}
	xhr.send(JSON.stringify({com:"pos",acc:user.acc,tok:user.tok(),pos:pos}));
}



function startGPS(){
	posWatch=navigator.geolocation.watchPosition(
		function(pos){ 
			if (pos.coords.accuracy<50000) // Change to lower value before launch
				position_found(pos); 
			else
				position_not_found();
		},
		function(error){ 
			position_not_found(); 
		},
		{ enableHighAccuracy:true, timeout:15000, maximumAge:10000 });
}
  
function stopGPS(){
	navigator.geolocation.clearWatch(posWatch);
}  

  function position_found(pos) {
	console.log("posfound");
    if (!marker){
		var icon = L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" src="'+user.pic+'"></div><div class="iconName" onclick="event.stopPropagation()">'+user.una+'</div>',iconAnchor:[12, 12]});
		marker = L.marker([pos.coords.latitude, pos.coords.longitude], {draggable:false, icon:icon}).addTo(map);
		}
	else{
		marker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
		//marker.update();
		}
	checkDistances();
  }

  function position_not_found() {
	removeMyMarkerFromMap();
  }

function startPosUpdates(){
	posUpdates = setInterval(function(){
		if (marker){
			updatePosition([parseFloat(marker.getLatLng().lat.toFixed(5)), parseFloat(marker.getLatLng().lng.toFixed(5))]);
		}
	}, 5000);
}

function stopPosUpdates(){
	clearInterval(posUpdates);
}

function startHealingChecks(){
	healingChecks = setInterval(function(){
		if (marker){
			checkForHealing();
		}
	}, 30000);
}

function stopHealingChecks(){
	clearInterval(healingChecks);
}
  
function zoomToUser(){
	if (marker) map.setView(marker.getLatLng(), 16);
}  
 
function showMapMenu(){
    document.getElementById('dimmer').style.display  = 'block'; 
    document.getElementById('mapBox').style.display  = 'block'; 
}
 
function setMap(m){
	map.removeLayer(currentMap); 
	currentMap=m;
	map.addLayer(m); 
	document.getElementById('dimmer').style.display  = 'none'; 
	document.getElementById('mapBox').style.display  = 'none'; 
}
  
  function showMessage(mess) {
    document.getElementById('dimmer').style.display  = 'block'; 
    document.getElementById('message').innerHTML = '<div id="closeMessageButton" onclick="closeMessage()" >x</div>' + mess; 
    document.getElementById('message').style.display = 'block';
  }  
  
  function closeMessage() {
    document.getElementById('message').style.display = 'none'; 
    document.getElementById('dimmer').style.display  = 'none'; 
  }
  
function distance(lat1, lon1, lat2, lon2) {
	var radlat1 = Math.PI * lat1/180
	var radlat2 = Math.PI * lat2/180
	var theta = lon1-lon2
	var radtheta = Math.PI * theta/180
	var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
	dist = Math.acos(dist)
	dist = dist * 180/Math.PI
	dist = dist * 60 * 1.1515 * 1609
	return dist
}

function checkDistances(){
	var lat = marker.getLatLng().lat;
	var lng = marker.getLatLng().lng;
	for (i=0;i<markers.length;i++){
		if (distance(lat,lng,targets[i].getLatLng().lat,targets[i].getLatLng().lng)<10){
			targets[i].setIcon(markerIcon2);
		}
	}
}

function checkForHealing(){
	var lat = marker.getLatLng().lat;
	var lng = marker.getLatLng().lng;
	for (i=0;i<pointsList.length;i++){
		if ((pointsList[i][1]==1)&&(distance(lat,lng,pointsList[i][2][0],pointsList[i][2][1])<50)){
			user.hea=user.hea+1;
			setBar('bar1',user.hea);
			break;
		}
	}
}


function startGame(g) {
	gameFrame.style.display = "block";
	closeGameFrame.style.display = "block";
    document.getElementById('gameFrame').src = "https://nile16.nu/pf/game"+g+".html?acc="+user.acc+"&tok="+user.tok();
	closeMessage();
}

function closeGame(){
	gameFrame.style.display = "none";
	closeGameFrame.style.display = "none";
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "https://nile16.nu:1208", true);
	xhr.onreadystatechange = function(){
		if(this.readyState == 4 && this.status == 200) {
			updateUserProfile(JSON.parse(xhr.responseText));
		}
	}
	xhr.send(JSON.stringify({com:"usr",acc:user.acc,tok:user.tok()}));
}

function loadPoints(){
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "https://nile16.nu:1208/", true);
	xhr.onreadystatechange = function(){
		if(this.readyState == 4 && this.status == 200) {
			pointsList = JSON.parse(xhr.responseText).poi;
			for (i=0;i<pointsList.length;i++){
				markers[i]=L.marker([pointsList[i].lat,pointsList[i].lon],{draggable:false, icon:L.divIcon({className: 'my-div-icon',html:'<div><img class="iconImage" onclick="markerClicked('+i+')" src="icons/'+pointsList[i].typ+'.png"></div>',iconAnchor:[8, 8]})}).addTo(map);
			}
		console.log(pointsList);
		}
	}
	xhr.send(JSON.stringify({com:"poi",acc:user.acc,tok:user.tok()}));
}

function markerClicked(m){
	var mess = pointsList[m].txt;
	if (pointsList[m].gam) mess += '<br><button onclick="startGame('+pointsList[m].gam+')" >Play</button>';
	showMessage(mess);
}



  // OSM layer
  var osmUrl='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  var osmAttrib='<a href="http://openstreetmap.org" target="_blank">OpenStreetMap</a>';
  var osm = new L.TileLayer(osmUrl, {minZoom:1, maxZoom:19});		
 
  // Mapbox layer
  var mapbox = L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic2VhcmNob3NtIiwiYSI6ImNpZ21vN2J0NzAwMjJhYWx4Zm95aTk1NW8ifQ.JmAKk8EayQ6cwMDJp-ZwVg', {minZoom:1, maxZoom: 18});
  //var mapbox = L.tileLayer('https://api.mapbox.com/styles/v1/searchosm/cj22dg5am006d2skh307zj406/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoic2VhcmNob3NtIiwiYSI6ImNpZ21vN2J0NzAwMjJhYWx4Zm95aTk1NW8ifQ.JmAKk8EayQ6cwMDJp-ZwVg', { tileSize: 512, zoomOffset: -1 });

  // Google Map layer
  var googleAttrib='<a href="http://www.google.com/maps" target="_blank">GoogleMaps</a>';
  var googleStreets = new L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{minZoom:1, maxZoom: 19, subdomains:['mt0','mt1','mt2','mt3']});

  new L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/emerald-v8/tiles/{z}/{x}/{y}?access_token=<your token>', { tileSize: 512, zoomOffset: -1, attribution: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});

  // Google terrain layer
  var googleTerrain = new L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{minZoom:1, maxZoom: 19, subdomains:['mt0','mt1','mt2','mt3']});

  // Google Earth layer
  var googleSat = new L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{minZoom:1, maxZoom: 19, subdomains:['mt0','mt1','mt2','mt3']});

  
  var map = new L.Map('map', { doubleClickZoom:false, zoomControl:false, maxBounds:([[90,-270],[-90,270]]) });

  map.attributionControl.setPrefix("");


  var user={};
  
  var posUpdates;
  var healingChecks;
  var posWatch;
  var pointsList=[];
  
  user.tok=function (){
      if (user.acc=="google")	return gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token;
      if (user.acc=="facebook")	return FB.getAuthResponse().accessToken;
  	return false;
  }


  var marker = false;
  var markers = L.featureGroup();
  
  //Set initial map view
  var currentMap=mapbox;
  
  //var markerIcon  = L.icon({iconUrl: "icons/0.png",iconAnchor:[8, 8],});
  var ios     = /(iPad|iPhone|iPod)/g.test(navigator.userAgent);
  var android = /(android)/i.test(navigator.userAgent);

  // Add layers to map
  currentMap.addTo(map);


  // map.addLayer(markers);
  map.fitBounds([[0,-180],[0,180]]);

	
	

  </script>                              

</html>

